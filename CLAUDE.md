# CLAUDE.md

This file provides guidance for Claude Code when working with this repository.

## Project Overview

This is the QuickBase Go SDK - a Go client for the QuickBase JSON RESTful API. It mirrors the feature set of [quickbase-js](https://github.com/DrewBradfordXYZ/quickbase-js).

## Architecture

```
quickbase-go/
├── quickbase.go           # Main entry point, re-exports, New() function
├── client/
│   ├── client.go          # HTTP client with auth, retry, rate limiting
│   ├── pagination.go      # Pagination helpers (iterator, collect, fluent API)
│   └── throttle.go        # Rate limiting (SlidingWindowThrottle, NoOpThrottle)
├── auth/
│   ├── strategy.go        # Auth interface
│   ├── user_token.go      # User token auth
│   ├── temp_token.go      # Temporary token auth
│   └── sso_token.go       # SSO/SAML auth
├── core/
│   ├── errors.go          # Error types (RateLimitError, NotFoundError, etc.)
│   ├── dates.go           # ISO date parsing utilities
│   └── logger.go          # Debug logger
├── internal/generated/
│   └── quickbase.gen.go   # Auto-generated from OpenAPI spec (DO NOT EDIT)
├── spec/                  # Git submodule with OpenAPI spec
└── tests/
    └── integration/       # Integration tests (require credentials)
```

## Key Patterns

### Generated Client
The `internal/generated/quickbase.gen.go` file is auto-generated by oapi-codegen from the OpenAPI spec. It contains:
- Request/response types for all endpoints
- `ClientWithResponses` with typed methods like `GetAppWithResponse`, `RunQueryWithResponse`
- Union types using `From*` and `As*` methods (e.g., `FieldValue_Value`)

### Authentication Flow
1. `quickbase.New()` accepts auth options like `WithUserToken()`
2. Creates appropriate `auth.Strategy` implementation
3. `client.Client` uses strategy to add auth headers
4. On 401, strategy can refresh tokens (temp/SSO tokens)

### Request Flow
1. User calls `client.API().SomeMethodWithResponse(ctx, params)`
2. `authHTTPClient.Do()` intercepts the request
3. Applies throttling (waits if rate limited)
4. Adds auth headers via strategy
5. Makes request with retry logic
6. Returns typed response

## Common Commands

```bash
# Run all tests
go test ./...

# Run unit tests only
go test ./core/... ./client/...

# Run integration tests (requires .env)
go test ./tests/integration/... -v

# Build
go build ./...

# Tidy dependencies
go mod tidy

# Regenerate from OpenAPI spec (if spec changes)
go generate ./...
```

## Testing

### Unit Tests
Located in `*_test.go` files alongside source code. Use mocked data.

### Integration Tests
Located in `tests/integration/`. Require real QuickBase credentials:
1. Copy `.env.example` to `.env`
2. Set `QB_REALM` and `QB_USER_TOKEN`
3. Tests create ephemeral apps that are auto-cleaned up

## Working with Generated Types

The generated types can be tricky. Common patterns:

```go
// Creating a record
data := []generated.QuickbaseRecord{
    {
        "6": generated.FieldValue{Value: toFieldValue("text")},
        "7": generated.FieldValue{Value: toFieldValue(42)},
    },
}

// Helper to create FieldValue_Value union
func toFieldValue(v any) generated.FieldValue_Value {
    var fv generated.FieldValue_Value
    switch val := v.(type) {
    case string:
        fv.FromFieldValueValue0(val)
    case int:
        fv.FromFieldValueValue1(float32(val))
    case bool:
        fv.FromFieldValueValue2(val)
    }
    return fv
}
```

## Dependencies

- `github.com/oapi-codegen/runtime` - OpenAPI runtime for generated client
- `github.com/joho/godotenv` - Load .env files for integration tests

## Temporary Token Authentication

**This is a key architectural difference between the Go and JS SDKs.**

### The Core Insight
Temp tokens prove a user is logged into QuickBase via their browser session. The benefit is verification - you know the request came from someone actually logged into QuickBase.

### JS SDK (Browser/Code Pages)
The JS SDK can **fetch** temp tokens because it runs in the browser:
```javascript
// In temp-token.ts
const response = await this.fetchApi(url, {
  method: 'GET',
  headers,
  credentials: 'include', // <-- Sends browser cookies!
});
```
- Uses `credentials: 'include'` on the `/auth/temporary/{dbid}` request
- Browser automatically sends QuickBase session cookies
- Works in Code Pages where user is logged into QuickBase
- No user token needed - the browser session IS the auth

### Go SDK (Server-Side)
The Go SDK **receives** pre-existing temp tokens - it cannot fetch them:
- No browser cookies available on server
- Primary use case: receiving tokens from browser clients (e.g., Code Pages)
- Browser fetches tokens using user's QuickBase session, sends via HTTP headers

**Available options:**
- `quickbase.WithTempTokens(map[string]string{"dbid": token})` - Create client with tokens
- `auth.WithInitialTempToken(token)` - Create client with a single token
- `auth.WithInitialTempTokenForTable(token, dbid)` - When you know the table ID
- `strategy.SetToken(dbid, token)` - Add tokens during request lifecycle

### Why use temp tokens over user tokens?
- **Verification**: Proves user is logged into QuickBase right now
- **No credentials storage**: Your server doesn't need to store user tokens
- **Table-scoped**: More restrictive permissions
- **Short-lived**: ~5 minutes, limits damage if leaked

### Why NOT fetch temp tokens with a user token?
You technically CAN call `/auth/temporary/{dbid}` with a user token, but there's no point:
- If you have a user token, just use that directly
- The benefit of temp tokens is proving browser session - if you're using a user token, you've already bypassed that

### Browser-to-Server Token Flow
```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  QuickBase  │     │   Browser   │     │  Go Server  │
└─────────────┘     └─────────────┘     └─────────────┘
       │                   │                   │
       │  User opens       │                   │
       │  Code Page        │                   │
       │◄──────────────────│                   │
       │                   │                   │
       │  Browser fetches  │                   │
       │  temp token       │                   │
       │◄─────────────────►│                   │
       │                   │                   │
       │                   │  Request + token  │
       │                   │  (via headers)    │
       │                   │──────────────────►│
       │                   │                   │
       │                   │     API calls     │
       │◄──────────────────┼───────────────────│
       │                   │                   │
```

1. User opens Code Page in QuickBase (logged in)
2. Browser JavaScript fetches temp token using session cookies
3. Browser sends request to Go server with token in header (e.g., X-QB-Token-{dbid})
4. Go server extracts token from header and creates client
5. Go server makes API calls back to QuickBase using that token

## Related Repository

This SDK mirrors [quickbase-js](https://github.com/DrewBradfordXYZ/quickbase-js):
- Same feature set (auth methods, throttling, retry, error types)
- Same test patterns (unit + integration with ephemeral apps)
- Shared OpenAPI spec (git submodule)
