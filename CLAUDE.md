# CLAUDE.md

This file provides guidance for Claude Code when working with this repository.

## Project Overview

This is the QuickBase Go SDK - a Go client for the QuickBase JSON RESTful API. It mirrors the feature set of [quickbase-js](https://github.com/DrewBradfordXYZ/quickbase-js).

## Architecture

```
quickbase-go/
├── quickbase.go           # Main entry point, re-exports, New() function
├── client/
│   ├── client.go          # HTTP client with auth, retry, rate limiting
│   ├── pagination.go      # Pagination helpers (iterator, collect, fluent API)
│   └── throttle.go        # Rate limiting (SlidingWindowThrottle, NoOpThrottle)
├── auth/
│   ├── strategy.go        # Auth interface
│   ├── user_token.go      # User token auth
│   ├── temp_token.go      # Temporary token auth
│   └── sso_token.go       # SSO/SAML auth
├── core/
│   ├── errors.go          # Error types (RateLimitError, NotFoundError, etc.)
│   ├── dates.go           # ISO date parsing utilities
│   └── logger.go          # Debug logger
├── internal/generated/
│   └── quickbase.gen.go   # Auto-generated from OpenAPI spec (DO NOT EDIT)
├── spec/                  # Git submodule with OpenAPI spec
└── tests/
    └── integration/       # Integration tests (require credentials)
```

## Key Patterns

### Generated Client
The `internal/generated/quickbase.gen.go` file is auto-generated by oapi-codegen from the OpenAPI spec. It contains:
- Request/response types for all endpoints
- `ClientWithResponses` with typed methods like `GetAppWithResponse`, `RunQueryWithResponse`
- Union types using `From*` and `As*` methods (e.g., `FieldValue_Value`)

### Authentication Flow
1. `quickbase.New()` accepts auth options like `WithUserToken()`
2. Creates appropriate `auth.Strategy` implementation
3. `client.Client` uses strategy to add auth headers
4. On 401, strategy can refresh tokens (temp/SSO tokens)

### Request Flow
1. User calls `client.API().SomeMethodWithResponse(ctx, params)`
2. `authHTTPClient.Do()` intercepts the request
3. Applies throttling (waits if rate limited)
4. Adds auth headers via strategy
5. Makes request with retry logic
6. Returns typed response

## Common Commands

```bash
# Run all tests
go test ./...

# Run unit tests only
go test ./core/... ./client/...

# Run integration tests (requires .env)
go test ./tests/integration/... -v

# Build
go build ./...

# Tidy dependencies
go mod tidy

# Regenerate from OpenAPI spec (if spec changes)
go generate ./...
```

## Testing

### Unit Tests
Located in `*_test.go` files alongside source code. Use mocked data.

### Integration Tests
Located in `tests/integration/`. Require real QuickBase credentials:
1. Copy `.env.example` to `.env`
2. Set `QB_REALM` and `QB_USER_TOKEN`
3. Tests create ephemeral apps that are auto-cleaned up

## Working with Generated Types

The generated types can be tricky. Common patterns:

```go
// Creating a record
data := []generated.QuickbaseRecord{
    {
        "6": generated.FieldValue{Value: toFieldValue("text")},
        "7": generated.FieldValue{Value: toFieldValue(42)},
    },
}

// Helper to create FieldValue_Value union
func toFieldValue(v any) generated.FieldValue_Value {
    var fv generated.FieldValue_Value
    switch val := v.(type) {
    case string:
        fv.FromFieldValueValue0(val)
    case int:
        fv.FromFieldValueValue1(float32(val))
    case bool:
        fv.FromFieldValueValue2(val)
    }
    return fv
}
```

## Dependencies

- `github.com/oapi-codegen/runtime` - OpenAPI runtime for generated client
- `github.com/joho/godotenv` - Load .env files for integration tests

## Related Repository

This SDK mirrors [quickbase-js](https://github.com/DrewBradfordXYZ/quickbase-js):
- Same feature set (auth methods, throttling, retry, error types)
- Same test patterns (unit + integration with ephemeral apps)
- Shared OpenAPI spec (git submodule)
